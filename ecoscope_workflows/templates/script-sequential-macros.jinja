{% macro handle_call_method(t, params) %}
    {{ t.id }} = (
        {{ t.known_task.importable_reference.function }}
        .validate()
        {%- if t.partial %}
        .partial({% for arg in t.partial %}{{ arg }}={{ t.partial[arg] }}{% if not loop.last %},{% endif %}{% endfor %})
        {% endif %}
        .call(**params["{{ t.id }}"])
    )

{% endmacro %}


{% macro handle_map_method(t, params) %}
    {{ t.id }}_mapped_iterable = map(
        lambda kw: {{ t.known_task.importable_reference.function }}.validate().call(**kw),
        {% for arg in t.map_iterable %}
        [
            {
                "{{ arg }}": i,
                {%- if t.arg_dependencies %}
                {% for arg in t.arg_dependencies %}
                "{{ arg }}": {{ t.arg_dependencies[arg] }},
                {% endfor %}
                {%- endif %}
            } | params["{{ t.id }}"]
            for i in {{ t.map_iterable[arg] }}
        ],
        {% endfor %}
    )
    {{ t.id }} = list({{ t.id }}_mapped_iterable)
{% endmacro %}


{% macro handle_task(t, params) %}
{% if t.method == "call" %}
    {{ handle_call_method(t, params) }}
{% elif t.method == "map" %}
    {{ handle_map_method(t, params) }}
{% endif %}
{% endmacro %}
