id: patrol_workflow
workflow:
  # set 'global' groupers
  - name: Set Groupers
    id: groupers
    task: set_groupers

  # subject group observations
  - name: Get Subject Group Observations from EarthRanger
    id: subject_obs
    task: get_subjectgroup_observations
  - name: Transform Observations to Relocations
    id: subject_reloc
    task: process_relocations
    partial:
      observations: ${{ workflow.subject_obs.return }}
  - name: Transform Relocations to Trajectories
    id: subject_traj
    task: relocations_to_trajectory
    partial:
      relocations: ${{ workflow.subject_reloc.return }}
  - name: Add temporal index to Subject Trajectories
    id: traj_add_temporal_index
    task: add_temporal_index
    partial:
      df: ${{ workflow.subject_traj.return }}

  # subject group trajectories map layers
  - name: Split Subject Trajectories by Group
    id: split_subject_traj_groups
    task: split_groups
    partial:
      df: ${{ workflow.traj_add_temporal_index.return }}
      groupers: ${{ workflow.groupers.return }}
  - name: Create map layer for each trajectory group
    id: traj_map_layers
    task: create_map_layer
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.split_subject_traj_groups.return }}
  - name: Draw Ecomaps for each trajectory group
    id: traj_ecomap
    task: draw_ecomap
    mapvalues:
      argnames: geo_layers
      argvalues: ${{ workflow.traj_map_layers.return }}
  - name: Persist ecomap as Text
    id: ecomap_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.traj_ecomap.return }}
  - name: Create Map Widgets for Patrol Events
    id: traj_map_widgets_single_views
    task: create_map_widget_single_view
    map:
      argnames: [view, data]
      argvalues: ${{ workflow.ecomap_html_urls.return }}
  - name: Merge EcoMap Widget Views
    id: traj_grouped_map_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.traj_map_widgets_single_views.return }}
